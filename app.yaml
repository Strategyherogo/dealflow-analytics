# DigitalOcean App Platform Specification
# Deploy with: doctl apps update YOUR_APP_ID --spec app.yaml

name: monkfish-app
region: fra

services:
  - name: dealflow-analytics
    environment_slug: python
    github:
      branch: main
      deploy_on_push: true
      repo: Strategyherogo/dealflow-analytics
    
    # Instance configuration
    instance_count: 1
    instance_size_slug: apps-s-1vcpu-0.5gb  # Current configuration
    
    # HTTP configuration
    http_port: 8080
    
    # Environment variables
    envs:
      - key: ANTHROPIC_API_KEY
        scope: RUN_AND_BUILD_TIME
        type: SECRET
        value: EV[1:l113GEkVv8D1yiv58qpVRGIza4Ko5EkE:AjDyPm9Q/Ob+gC8n4Wc60c8X+ZzePuEiRiz1A7rO0VGrwQTOji3rD/7bKFgk05o92SnaexnamSnu8I3v3hkO6z+q2Cwqn91+r/E8NKLE7knFgqZJNZyiD81LaoHLNK706fLdmCupn8pUeBNokTQN8kJ2Do+gygMsxBg2cQ==]
      
      - key: STRIPE_SECRET_KEY
        scope: RUN_TIME
        type: SECRET
        value: ${STRIPE_SECRET_KEY}
      
      - key: STRIPE_WEBHOOK_SECRET
        scope: RUN_TIME
        type: SECRET
        value: ${STRIPE_WEBHOOK_SECRET}
      
      - key: STRIPE_PRO_PRICE_ID
        scope: RUN_TIME
        value: ${STRIPE_PRO_PRICE_ID}
      
      - key: STRIPE_PREMIUM_PRICE_ID
        scope: RUN_TIME
        value: ${STRIPE_PREMIUM_PRICE_ID}
      
      - key: STRIPE_ENTERPRISE_PRICE_ID
        scope: RUN_TIME
        value: ${STRIPE_ENTERPRISE_PRICE_ID}
      
      - key: STRIPE_TEST_MODE
        scope: RUN_TIME
        value: "true"
      
      - key: JWT_SECRET
        scope: RUN_TIME
        type: SECRET
        value: ${JWT_SECRET}
      
      - key: PYTHONUNBUFFERED
        scope: RUN_TIME
        value: "1"
      
      - key: LOG_LEVEL
        scope: RUN_TIME
        value: "INFO"
    
    # CORS configuration for Chrome extension
    cors:
      allow_origins:
        - prefix: chrome-extension://
      allow_methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allow_headers:
        - Content-Type
        - Authorization

# Database (PostgreSQL)
databases:
  - name: db
    engine: PG
    version: "15"
    size: db-s-dev-database  # $7/month (1GB RAM, 10GB disk)
    # For production use: db-s-1vcpu-1gb ($15/month)
    num_nodes: 1

# Redis for caching
# Note: DigitalOcean doesn't have managed Redis yet, 
# so we'll use an in-memory cache in the app for now
# or deploy Redis as a separate service

# Alternative: Add Redis as a service
# services:
#   - name: redis
#     dockerfile_path: redis/Dockerfile
#     source_dir: redis
#     instance_count: 1
#     instance_size_slug: basic-xxs
#     internal_ports:
#       - 6379

# Alerts (optional)
alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED
  - rule: CPU_UTILIZATION
    value: 80
    window: FIVE_MINUTES
  - rule: MEM_UTILIZATION
    value: 80
    window: FIVE_MINUTES

# For custom domain (add after deployment)
# domains:
#   - domain: api.dealflow.com
#     type: PRIMARY
#     zone: dealflow.com